#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <conio.h>

// --- Прототипи функцій ---
double function(double x);
// Оголошуємо прототип функції, яка буде друкувати всю таблицю. Вона не повертає значення (void).
void printTable(double X1, unsigned int N, double step);
// Оголошуємо прототип функції для друку "шапки" таблиці.
void print_table_header();
// Оголошуємо прототип функції для друку лінії-розділювача.
void print_table_line();

// --- Головна функція програми ---
int main()
{ 

    // Оголошуємо змінні для зберігання дробових чисел
    double X1, X2, delta;
    // Оголошуємо змінну для кількості точок (ціле, беззнакове, тобто не може бути від'ємним).
    unsigned int N;
    // Оголошуємо тимчасову змінну для безпечного зчитування N (щоб уникнути помилок при вводі).
    int temp;
    // Оголошуємо змінну для зберігання вибору користувача (1 або 2).
    int variant;



    
    printf("Enter variant (1 or 2): ");    // Просимо користувача обрати варіант.
    scanf("%d", &variant);                 

    while(variant != 1 && variant != 2) // Починаємо цикл: "ПОКИ 'variant' НЕ дорівнює 1 І одночасно НЕ дорівнює 2, виконувати...".
    {                                  
        printf("\nVariant must be 1 or 2"); // Виводимо повідомлення про помилку.
        printf("\nEnter variant: ");         // Просимо ввести варіант ще раз.
        scanf("%d", &variant);               // Зчитуємо повторне введення.
    }                                  

    printf("\nEnter X1: "); // Просимо користувача ввести початкову точку діапазону.
    scanf("%lf", &X1);    
    
    do { // Починаємо цикл do-while, який виконається хоча б один раз.
        printf("\nEnter X2 (must be > X1): "); // Просимо ввести кінцеву точку, нагадуючи про умову.
        scanf("%lf", &X2);                       
        if (X2 <= X1) {                          // Перевіряємо, чи введене значення неправильне.
            printf("\nError. X2 must be greater than X1. Please try again.\n"); // Якщо так, виводимо помилку.
        }                                       
    } while (X2 <= X1);                          // Повторювати цикл, ПОКИ X2 менше або дорівнює X1.

    
    if(variant == 1) // Перевіряємо, чи користувач обрав перший варіант.
    { // Початок блоку для варіанту 1.
        printf("\nEnter N (number of points >= 2): "); // Просимо ввести кількість точок.
        scanf("%d", &temp);                            
        while(temp <= 1)                               // Починаємо цикл валідації: ПОКИ 'temp' менше або дорівнює 1...
        {                                            
            printf("\nError. N must be 2 or greater."); // Виводимо помилку.
            printf("\nEnter N: ");                      // Просимо ввести N ще раз.
            scanf("%d", &temp);                        // Зчитуємо нове значення.
        }                                              
        N = (unsigned int)temp; // Присвоюємо перевірене значення змінній N 

        // Розраховуємо крок: довжина діапазону поділена на кількість проміжків.
        delta = (X2 - X1) / ((double)(N - 1)); 
    } // Кінець блоку для варіанту 1.
    else // ІНАКШЕ (якщо користувач обрав не 1, а 2 варіант).
    { // Початок блоку для варіанту 2.
        do { // Починаємо цикл do-while для валідації кроку.
            printf("\nEnter delta (step > 0): "); 
            scanf("%lf", &delta);                 
            if (delta <= 0) {                     // Перевіряємо, чи крок не є додатним числом.
                printf("\nError. Delta must be positive.\n"); // Якщо так, виводимо помилку.
            }                                    
        } while (delta <= 0);                     // Повторювати цикл, ПОКИ 'delta' менше або дорівнює 0.

        // Розраховуємо кількість точок, яка вийде при заданому кроці.
        N = (unsigned int)((X2 - X1) / delta) + 1; 
    } 

    // --- ВИКЛИК ФУНКЦІЇ ДЛЯ ДРУКУ ТАБЛИЦІ ---
    // Викликаємо функцію для друку таблиці, передаючи їй усі розраховані параметри.
    printTable(X1, N, delta); 

    return 0; 
}


// --- Реалізація функцій ---
// f(x) = 2(x-1000)^3 - 3(x+500)^2 + 4x - 5
double function(double x) { 
    return 2.0 * pow(x - 1000.0, 3) - 3.0 * pow(x + 500.0, 2) + 4.0 * x - 5.0;
}

// Функція для розрахунку та виводу таблиці.
void printTable(double X1, unsigned int N, double step) {
    unsigned int i; // Оголошуємо лічильник для циклу.
    double x, fx, prev_fx = 0.0; // Оголошуємо змінні: поточний 'x', поточне значення f(x), попереднє значення f(x).
    
    unsigned int displayedLines = 0; 
    const int maxLinesPerScreen = 20; 
    
    printf("\n\n--- Calculation parameters ---\n"); // Виводимо заголовок з параметрами.
    printf("Start X: %.4f\n", X1);                // Виводимо початкове значення X.
    printf("Points:  %u\n", N);                  // Виводимо кількість точок.
    printf("Step:    %.4f\n\n", step);             // Виводимо крок.

    print_table_header(); // Викликаємо функцію, яка малює "шапку" таблиці.

    // Головний цикл для обчислення та виводу, виконується N разів.
    for (i = 0; i < N; i++) {
        x = X1 + i * step; // Обчислюємо поточне значення 'x'.
        fx = function(x);  // Викликаємо нашу математичну функцію і зберігаємо результат в 'fx'.

        // Виводимо один рядок таблиці, форматуючи значення по стовпцях.
        printf("| %-5u | %-26.4f | %-23.4f |\n", i + 1, x, fx);
        displayedLines++; // Збільшуємо лічильник виведених рядків на 1.

        if (i > 0 && fx * prev_fx < 0) { // Перевіряємо, чи змінився знак функції (якщо це не перша точка).
            print_table_line(); // Малюємо лінію-розділювач.
            printf("!!! Attention: Function changed sign on the interval [%.4f, %.4f] !!!\n", x - step, x); // Виводимо повідомлення.
            print_table_line(); // Малюємо ще одну лінію.
            displayedLines += 3; // Додаємо 3 до лічильника виведених рядків (бо ми вивели 3 додаткові рядки).
        }
        prev_fx = fx; // Зберігаємо поточне значення 'fx' для наступної ітерації.

        // Пагінація (перевірка, чи потрібно зробити паузу).
        if (displayedLines >= maxLinesPerScreen && i < N - 1) { // Якщо рядків виведено 20 або більше І це не останній рядок...
            print_table_line(); // Малюємо нижню лінію.
            printf("Press any key to continue...\n"); // Просимо натиснути клавішу.
            getch(); // Чекаємо на натискання будь-якої клавіші.
            displayedLines = 0; // Скидаємо лічильник рядків на 0 для наступного "екрану".
        }
    }
    print_table_line(); // Малюємо фінальну нижню лінію таблиці.
}


void print_table_header() {
    print_table_line(); // Малюємо верхню лінію.
    // Виводимо назви стовпців, вирівнюючи їх по ширині (5, 26, 23 символи).
    printf("| %-5s | %-26s | %-23s |\n", "N", "X", "F(X)");
    print_table_line(); // Малюємо лінію під заголовком.
}

void print_table_line() {
    printf("+-------+----------------------------+-------------------------+\n");
}
